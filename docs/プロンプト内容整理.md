# メール・画像解析プロンプト 内容整理

※ `order_processing.py` の `parse_order_image` と `parse_order_text` で使っているプロンプトの一覧です。  
※ `{store_list}`, `{unit_lines}`, `{box_count_str}`, `{spec_master_section}` などは実行時にマスタから組み立てた文字列に置き換わります。

---

## 1. 画像解析用プロンプト（parse_order_image）

```
画像を解析し、以下の厳密なルールに従ってJSONで返してください。

【画像読み取りの精度・誤認識を防ぐ注意】
- 画像に実際に写っている文字・数字のみを読み取ってください。写っていない内容を推測や憶測で補完しないでください。
- 店舗名・品目名・規格・数量（数字）は、画像の表記と一致するよう一字一句確認してからJSONに反映してください。
- 読みにくい部分は推測で埋めず、見えている通りに読み取るか、確信が持てない場合は控えめに解釈してください。

【店舗名リスト（参考）】
{store_list}
※上記リストにない店舗名も読み取ってください。

【品目名の正規化ルール】
{item_normalization のJSON}

{spec_master_section}
※ 品目・規格マスタ（読み取り・計算の参照）の表

【重要ルール】
1. 店舗名の後に「:」または改行がある場合、その後の行は全てその店舗の注文です
2. 品目名がない行（例：「50×1」）は、直前の品目の続きとして処理してください
3. 「/」で区切られた複数の注文は、同じ店舗・同じ品目として統合してください
4. 「胡瓜バラ」と「胡瓜3本」は別の規格として扱ってください
5. unit と total には「数字のみ」を入れてください。箱数・端数は出力不要です（Python側で計算します）。

【計算ルール（上記マスタ＝1コンテナあたりの入数）】
{unit_lines}

【合計数量(total)の取り方】
- 合計数量：メール内の「×」の後の数字を合計数量(total)とします。※「胡瓜バラ 50×4」のように「数×数」の表記の場合は、50×4＝200 として total に入れてください。
- 箱数で受信する品目（{box_count_str}）のみ：「×」の後の数字を箱数とし、合計数量＝箱数×入数 として total に入れてください（例：4箱・入数30 → total=120）。箱数・端数は出力不要です（Python側で計算します）。

【出力JSON形式】
[{"store":"店舗名","item":"品目名","spec":"規格","unit":数字,"total":数字}]

（画像からの解析ですが、形式は同じJSONです）

必ず全ての店舗と品目を漏れなく読み取ってください。
```

---

## 2. メール（テキスト）解析用プロンプト（parse_order_text）

```
メール本文から注文情報を抽出し、JSON形式で返してください。

【送信者】{sender}
【件名】{subject}

【店舗名リスト（参考）】
{store_list}
※リストになくても、文脈から店舗名と判断できる場合は抽出してください。

【品目名の正規化ルール】
{item_normalization のJSON}

{spec_master_section}

【計算ルール（1コンテナあたりの入数）】
{unit_lines}

【合計数量(total)の取り方】
- 合計数量：メール内の「×」の後の数字を合計数量(total)とします。※「胡瓜バラ 50×4」のように「数×数」の表記の場合は、50×4＝200 として total に入れてください。
- 箱数で受信する品目（{box_count_str}）のみ：「×」の後の数字を箱数とし、合計数量＝箱数×入数 として total に入れてください。箱数・端数は出力不要（Python側で計算）。

【重要ルール】
- 出力は純粋なJSONのみ (Markdown記法なし)。
- unit と total には「数字のみ」を入れてください。
- 日付情報が含まれている場合でも、今回の出力には含めず、注文明細のみ抽出してください。

【出力JSON形式】
[{"store":"店舗名","item":"品目名","spec":"規格","unit":数字,"total":数字}]

【メール本文】
{text}
```

---

## 3. 品目ごとの入り数（計算ルールの元データ）

**入り数は「品目名管理」マスタで定義されています。** プロンプトには実行時にこのマスタから組み立てた文字列が埋め込まれます。

- **参照元**: 設定管理の「品目名管理」（ファイルは `config/item_spec_master.json` またはアプリ上で編集したマスタ）
- **1行の内容**: 品目・規格ごとに **default_unit（1コンテナあたりの入数）**、**unit_type（袋/本など）**、**受信方法（総数 or 箱数）** を保持
- **規格が空の行**: 規格が空の場合はプロンプトに「規格なし」と表示されます（例：長ネギ(規格なし)）。品目名に規格を含む行（胡瓜平箱・胡瓜バラなど）も、マスタでは 品目・規格 を分けて持てます。

プロンプトに渡されるときの形式の例（マスタの 品目・規格 に対応）：

| 品目 | 規格 | 入数(unit) | 単位 | 受信方法 | プロンプトでの表記例 |
|------|------|------------|------|----------|----------------------|
| 胡瓜 | 3本 | 30 | 袋 | 総数 | 胡瓜(3本): 30袋/コンテナ |
| 胡瓜平箱 | 平箱 | 30 | 袋 | 箱数 | 胡瓜平箱(平箱): 30袋/コンテナ |
| 胡瓜バラ | バラ | 100 | 本 | 総数 | 胡瓜バラ(バラ): 100本/コンテナ |
| 長ネギ | （空） | 50 | 本 | 総数 | 長ネギ(規格なし): 50本/コンテナ |
| 春菊 | 1束 | 30 | 袋 | 総数 | 春菊(1束): 30袋/コンテナ |
| 青梗菜 | 2~3株 | 20 | 袋 | 総数 | 青梗菜(2~3株): 20袋/コンテナ |

- **unit_lines**: 上記の「品目(規格): ○○単位/コンテナ」だけを改行で並べたもの（計算ルール用）。入数が 0 の行は計算ルールに含まれません。
- **spec_master_section**: 同じマスタから「品目(規格): ○○/コンテナ, 受信方法=総数/箱数」まで含めたブロック全文
- 入り数や規格を変えたい場合は **設定管理 > 品目名管理** で該当の品目・規格を編集すると、次回の解析からプロンプトに反映されます。

---

## 4. 合計数量・箱数・端数（AIは total のみ返却、計算は Python）

- **AIの出力**：JSON の `unit` と `total`（合計数量）のみ。箱数・端数は出力しない。
- **合計数量(total)**：メール内の「×」の後の数字。※「胡瓜バラ 50×4」の場合は 50×4＝200 を total に。箱数で受信する品目は「×」の後を箱数とし、合計数量＝箱数×入数 を total に。
- **Python側の計算**：`箱数(boxes) = total // unit`（商）、`端数(remainder) = total % unit`（余り）。入数が0のときはマスタから入数を補い、その後で計算する。

---

## 5. 実行時に組み立てられるブロック（変数一覧）

| 変数 | 内容 |
|------|------|
| `store_list` | 店舗名を「、」で連結 |
| `item_normalization` | items.json の品目名正規化ルール（キー＝正規名、値＝表記ゆれのリスト） |
| `spec_master_section` | 品目名管理マスタから生成。「品目(規格): ○○/コンテナ, 受信方法=総数/箱数」の一覧 |
| `unit_lines` | 品目ごとの入り数（上記マスタの「品目(規格): 入数単位/コンテナ」を列挙した行。default_unit が 0 の行は含まれない） |
| `box_count_str` | 受信方法が「箱数」の品目・規格だけを「、」で連結（「×数字」が箱数になる品目） |

---

## 6. 解析後にコード側で行っている処理（プロンプト外）

- **規格の正規化**: `normalize_spec_from_parse(spec)` … ばら→バラ、平箱→平箱、N本はそのまま
- **規格が空のときの既定値**: 品目に応じて `get_default_spec_for_item(item)` で補う（例：春菊→1束、青梗菜→2~3株）
- **箱数・端数を Python で計算**: `_compute_boxes_remainder_from_total(entries)` … AI が返した `total` から `boxes = total // unit`、`remainder = total % unit` を算出して entry に設定。入数が0のときはマスタから補う
- **個数と箱数の取り違え補正**: AI が boxes/remainder 形式で返した場合のみ `_fix_boxes_remainder_when_count_misread_as_boxes(entries)` を実行

---

## 7. 画像用とメール用の違い（要約）

| 項目 | 画像 | メール |
|------|------|--------|
| 冒頭 | 画像を解析し… | メール本文から抽出し… |
| 誤認識防止 | **画像読み取りの精度**：写っている内容のみ読み取る・推測で補完しない・数量等は表記と一致させる | なし |
| コンテキスト | なし | 送信者・件名 |
| 重要ルール | 5項目（店舗・品目続き・統合・規格・数字のみ） | 総数/箱数判断・JSONのみ・数字のみ・日付除外 |
| 合計数量・箱数・端数 | 【合計数量・箱数・端数の定義】で 合計数量＝「×」の後／50×4は掛算、boxes＝商、remainder＝余り、注意 | 同上 |

プロンプトの文言を変えたい場合は、このファイルで案を書いたうえで `order_processing.py` の該当 f-string を編集してください。
