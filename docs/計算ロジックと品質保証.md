# 箱数・端数・合計数量の計算ロジックと品質保証

このドキュメントは、**箱数(boxes)・端数(remainder)・合計数量(total)・入数(unit)** の計算を絶対に間違えないための、多方面からの対策一覧です。

---

## 定義（絶対に変えない）

| 用語 | 意味 |
|------|------|
| **入数 (unit)** | 1コンテナ（1箱）あたりの数量。品目・規格マスタで定義。 |
| **箱数 (boxes)** | 満タン箱の個数。整数 ≥ 0。 |
| **端数 (remainder)** | 満タンに満たない残り数量。整数 ≥ 0。 |
| **合計数量 (total)** | その品目・店舗の総数量。 |

**成り立つ式（不変条件）**

- `合計数量 = 入数 × 箱数 + 端数`
- 入数 > 0 のとき: `箱数 = 合計数量 ÷ 入数` の**商**、`端数 = 合計数量 ÷ 入数` の**余り**
- したがって **0 ≤ 端数 < 入数**（入数 > 0 のとき）
- 入数 ≤ 0 のとき: 箱数は 0、端数 = 合計数量（全部端数扱い）

---

## 多方面からの対策一覧

### 1. 単一責任・共通モジュール（実装済み）

- **やること**: 箱数・端数を求める計算を**1か所**に集約する。
- **モジュール**: `box_remainder_calc.py`
  - `total_to_boxes_remainder(total, unit)` → `(boxes, remainder)`
  - `boxes_remainder_to_total(unit, boxes, remainder)` → total
- **効果**: 割り算を書く場所が1か所になるため、仕様変更・バグ修正の影響範囲が明確になる。他モジュールはこのAPIを呼ぶだけにし、**直書きの `//` / `%` を禁止**する。

### 2. 単体テスト・不変条件テスト（実装済み）

- **やること**:
  - 上記共通モジュールの単体テストで、代表値・境界値（total=0, unit=0, total&lt;unit, total=unit, 端数のみ など）をカバーする。
  - **不変条件のテスト**: `total == unit * boxes + remainder` および `0 <= remainder < unit`（unit&gt;0）が常に成り立つことをテストする。
- **効果**: リファクタや他機能の変更で計算が壊れたら、テスト失敗で即検知できる。

### 3. リグレッションテスト（実装済み）

- **やること**: 過去に起きたバグを再現するテストを残す。
  - 例: 「unit に総数が入っていた」補正で、`boxes = total // unit`, `remainder = total % unit` になること（boxes=元unit ではない）。
- **効果**: 同じミスが再発しないようにする。

### 4. ドキュメントの一元化（本ドキュメント）

- **やること**:
  - 計算の定義・不変条件を **docs/計算ロジックと品質保証.md** に記載する。
  - **docs/プロンプト内容整理.md** では「合計数量・箱数・端数はPython側で計算」「計算は box_remainder_calc を参照」と明記する。
- **効果**: 仕様の解釈がぶれない。新人・AIアシスタントも同じ定義を参照できる。

### 5. Cursor ルール（実装済み）

- **やること**: `.cursor/rules/calculation-logic.mdc` で「箱数・端数・合計の計算を触る場合は必ず `box_remainder_calc` を使う。`//` / `%` の直書き禁止」とルール化する。
- **効果**: コード編集時にルールが適用され、直書きによる再発を防ぐ。

### 6. アサーション（オプション）

- **やること**: 計算結果を使う直前に、開発時のみ `assert 0 <= remainder < unit` や `assert total == unit * boxes + remainder` を入れる（本番では無効化可）。
- **効果**: 不正な値が混ざった時点で落ちて原因を追いやすい。パフォーマンスが気になる場合はテストのみで使う。

### 7. 型・バリデーション（オプション）

- **やること**: 関数の引数で `unit > 0` や `total >= 0` をチェックし、不正なら 0 に丸めるかエラーにする。必要なら `TypedDict` で unit/boxes/remainder をまとめる。
- **効果**: 負の数や None の混入を防ぎ、不変条件を守りやすくする。

### 8. コードレビュー観点

- **やること**: PR で「箱数・端数・合計」に触れる変更があれば、チェックリストで確認する。
  - 計算は `box_remainder_calc` 経由か？
  - 不変条件 `total = unit*boxes + remainder`、`0 <= remainder < unit` を満たすか？
  - unit=0 や total=0 のときの挙動は仕様どおりか？
- **効果**: 人的な二重チェックで取りこぼしを減らす。

### 9. CI でテスト必須化

- **やること**: push / PR で `pytest tests/test_box_remainder_calc.py` および関連テストを必ず実行する。
- **効果**: 計算ロジックを壊す変更が main に入るのを防ぐ。

### 10. 特別ロジックの分離とコメント

- **やること**: 「unit に総数が入っていた」補正や「箱数で受信」の解釈など、例外パターンは関数として分離し、**なぜその変換をするか**をコメントで明記する。
- **効果**: 意図が残り、将来の変更で誤って「普通の割り算」に書き換えられるリスクを減らす。

---

## 計算を参照・変更しているファイル一覧

| ファイル | 役割 | 使用すべきAPI |
|----------|------|----------------|
| `box_remainder_calc.py` | 計算の唯一の実装 | - |
| `order_processing.py` | 解析後の箱数・端数計算、補正 | `total_to_boxes_remainder` |
| `delivery_converter.py` | 台帳行→v2形式、数量逆算 | `total_to_boxes_remainder`, `boxes_remainder_to_total`（通常時） |
| `app.py` | 表の合計数量表示・「unitを総数と解釈」補正 | `total_to_boxes_remainder`（補正時）、表示は `unit*boxes+remainder` |

**新しく箱数・端数・合計に触れるコードを書くときは、上記APIを使い、直書きの割り算を追加しないこと。**

---

## 変更時のチェックリスト

- [ ] 計算は `box_remainder_calc` の関数を使ったか（`//` / `%` の直書きをしていないか）
- [ ] unit=0, total=0, total&lt;unit のケースを考慮したか
- [ ] 不変条件 `total = unit*boxes+remainder`、`0 <= remainder < unit` を満たすか
- [ ] 必要なら `tests/test_box_remainder_calc.py` にテストを追加したか
- [ ] 特別な解釈（「unitが総数」など）には理由のコメントを付けたか
