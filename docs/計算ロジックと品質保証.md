# 箱数・端数・合計数量の計算ロジックと品質保証

このドキュメントは、**箱数(boxes)・端数(remainder)・合計数量(total)・入数(unit)** の計算を絶対に間違えないための、多方面からの対策一覧です。

**現在の計算ロジックは完璧なものとして維持する。** 変更時は本ドキュメント・正規仕様テスト（`tests/test_calculation_logic_canonical.py`）・チェックリストを必ず満たすこと。

---

## ⚠️ 致命的に守るべきルール（絶対に崩さないこと）

**このルールを誤ると注文数量が桁違いになり、出荷・請求に致命的な誤りが発生します。プロンプト修正・解析ロジック変更時は必ず以下を満たすこと。**

### 1. 注文メール／画像における「×」の解釈

| ルール | 正しい解釈 | 誤った解釈（禁止） |
|--------|------------|---------------------|
| **「×」の直後の数字** | **合計数量（総数）** そのもの | 箱数・または「その数×入数」ではない |
| 胡瓜3本×150 | total=**150** → 箱数5, 端数0（入数30） | ~~total=4500（150箱）~~ |
| 春菊×20 | total=**20** → 箱数0, 端数20（入数30） | ~~total=600（20×30）~~ |
| 青梗菜×15 | total=**15** → 箱数0, 端数15（入数20） | ~~total=300（15×20）~~ |

**例外（この2つだけ「×の後」が箱数または掛け算）**

- **箱数で受信する品目**（胡瓜平箱など）のみ：「×」の後を**箱数**とし、total = 箱数×入数。例：胡瓜平箱×1 → total=50。
- **「50×4」のような掛け算表記**（50本が4つ）：50×4=200 を total にする。

### 2. 箱数・端数の算出（唯一の正解)

- **箱数 = 合計数量 ÷ 入数 の商**（整数除算）
- **端数 = 合計数量 ÷ 入数 の余り**
- 実装は **`box_remainder_calc.total_to_boxes_remainder(total, unit)` のみ**使用。他で `//` / `%` の直書きを追加しない。

### 3. プロンプトを触るときの禁止事項

- プロンプトに「春菊×20 → total=600」「青梗菜×15 → total=300」「胡瓜3本×150 → total=4500」など、**「×の後＝合計数量」に反する例を書かない。**
- 正しい例のみ記載する：春菊×20 → **total=20**、胡瓜3本×150 → **total=150**。

---

## 定義（絶対に変えない）

| 用語 | 意味 |
|------|------|
| **入数 (unit)** | 1コンテナ（1箱）あたりの数量。品目・規格マスタで定義。 |
| **箱数 (boxes)** | 満タン箱の個数。整数 ≥ 0。 |
| **端数 (remainder)** | 満タンに満たない残り数量。整数 ≥ 0。 |
| **合計数量 (total)** | その品目・店舗の総数量。 |

**成り立つ式（不変条件）**

- `合計数量 = 入数 × 箱数 + 端数`
- 入数 > 0 のとき: `箱数 = 合計数量 ÷ 入数` の**商**、`端数 = 合計数量 ÷ 入数` の**余り**
- したがって **0 ≤ 端数 < 入数**（入数 > 0 のとき）
- 入数 ≤ 0 のとき: 箱数は 0、端数 = 合計数量（全部端数扱い）

---

## 多方面からの対策一覧

### 1. 単一責任・共通モジュール（実装済み）

- **やること**: 箱数・端数を求める計算を**1か所**に集約する。
- **モジュール**: `box_remainder_calc.py`
  - `total_to_boxes_remainder(total, unit)` → `(boxes, remainder)`
  - `boxes_remainder_to_total(unit, boxes, remainder)` → total
- **効果**: 割り算を書く場所が1か所になるため、仕様変更・バグ修正の影響範囲が明確になる。他モジュールはこのAPIを呼ぶだけにし、**直書きの `//` / `%` を禁止**する。

### 2. 単体テスト・不変条件テスト（実装済み）

- **やること**:
  - 上記共通モジュールの単体テストで、代表値・境界値（total=0, unit=0, total&lt;unit, total=unit, 端数のみ など）をカバーする。
  - **不変条件のテスト**: `total == unit * boxes + remainder` および `0 <= remainder < unit`（unit&gt;0）が常に成り立つことをテストする。
- **効果**: リファクタや他機能の変更で計算が壊れたら、テスト失敗で即検知できる。

### 3. リグレッションテスト（実装済み）

- **やること**: 過去に起きたバグを再現するテストを残す。
  - 例: 「unit に総数が入っていた」補正で、`boxes = total // unit`, `remainder = total % unit` になること（boxes=元unit ではない）。
- **効果**: 同じミスが再発しないようにする。

### 4. ドキュメントの一元化（本ドキュメント）

- **やること**:
  - 計算の定義・不変条件を **docs/計算ロジックと品質保証.md** に記載する。
  - **docs/プロンプト内容整理.md** では「合計数量・箱数・端数はPython側で計算」「計算は box_remainder_calc を参照」と明記する。
- **効果**: 仕様の解釈がぶれない。新人・AIアシスタントも同じ定義を参照できる。

### 5. Cursor ルール（実装済み）

- **やること**: `.cursor/rules/calculation-logic.mdc` で「箱数・端数・合計の計算を触る場合は必ず `box_remainder_calc` を使う。`//` / `%` の直書き禁止」とルール化する。
- **効果**: コード編集時にルールが適用され、直書きによる再発を防ぐ。

### 6. 不変条件検証（実装済み）

- **やること**: `box_remainder_calc.validate_entry_invariant(entry)` で 1 件の entry が「合計＝入数×箱数＋端数」「0≤端数<入数」を満たすか検証できる。テストやデバッグ時に利用。
- **効果**: 解析結果やUI経由のデータが不変条件を満たさない場合に検知できる。

### 7. 型・バリデーション（オプション）

- **やること**: 関数の引数で `unit > 0` や `total >= 0` をチェックし、不正なら 0 に丸めるかエラーにする。必要なら `TypedDict` で unit/boxes/remainder をまとめる。
- **効果**: 負の数や None の混入を防ぎ、不変条件を守りやすくする。

### 8. コードレビュー観点

- **やること**: PR で「箱数・端数・合計」に触れる変更があれば、チェックリストで確認する。
  - 計算は `box_remainder_calc` 経由か？
  - 不変条件 `total = unit*boxes + remainder`、`0 <= remainder < unit` を満たすか？
  - unit=0 や total=0 のときの挙動は仕様どおりか？
- **効果**: 人的な二重チェックで取りこぼしを減らす。

### 9. CI でテスト必須化

- **やること**: push / PR で計算ロジック関連テストを必ず実行する。
  - 一括実行: `scripts/run_calculation_tests.ps1`（Windows）または `scripts/run_calculation_tests.sh`
  - または: `pytest tests/test_box_remainder_calc.py tests/test_calculation_logic_canonical.py tests/test_order_processing.py -v`
- **効果**: 計算ロジックを壊す変更が main に入るのを防ぐ。

### 10. 特別ロジックの分離とコメント

- **やること**: 「unit に総数が入っていた」補正や「箱数で受信」の解釈など、例外パターンは関数として分離し、**なぜその変換をするか**をコメントで明記する。
- **効果**: 意図が残り、将来の変更で誤って「普通の割り算」に書き換えられるリスクを減らす。

---

## 計算を参照・変更しているファイル一覧

| ファイル | 役割 | 使用すべきAPI |
|----------|------|----------------|
| `box_remainder_calc.py` | 計算の唯一の実装 | - |
| `order_processing.py` | 解析後の箱数・端数計算、補正 | `total_to_boxes_remainder` |
| `delivery_converter.py` | 台帳行→v2形式、数量逆算 | `total_to_boxes_remainder`, `boxes_remainder_to_total`（通常時） |
| `app.py` | 表の合計数量表示・「unitを総数と解釈」補正 | `total_to_boxes_remainder`（補正時）、表示は `unit*boxes+remainder` |

**新しく箱数・端数・合計に触れるコードを書くときは、上記APIを使い、直書きの割り算を追加しないこと。**

---

## 現在の正解ロジック（正規仕様・変更禁止）

**以下は「今の計算ロジックが完璧なもの」として固定する。変更する場合は本ドキュメントとテストの両方を必ず更新し、全テスト通過を確認すること。**

### 入り数マスタの参照

- 品目・規格が分かれた場合の複合名参照: (胡瓜, バラ)→胡瓜バラ, (胡瓜, 平箱)→胡瓜平箱, (長ネギ, バラ)→長ねぎバラ（`config_manager.ITEM_SPEC_COMPOSITE_LOOKUP`）。これを削除・変更すると胡瓜バラ100入り等が正しく参照されなくなる。

### 補正ルールの厳密な条件

- **`_fix_total_when_ai_sent_boxes_times_unit`**: **total > 1000** のときだけ補正する。total=300, 500 などは正しい合計なので補正してはいけない。
- 補正条件: `total > 1000 and total == unit * boxes and 10 <= boxes <= 1000` かつ 箱数で受信でない品目。

### 正解例（入力→期待値）

| 入力 | 入数 | 期待: 合計 | 箱数 | 端数 |
|------|------|------------|------|------|
| 胡瓜3本×150 | 30 | 150 | 5 | 0 |
| 胡瓜3本×300 | 30 | 300 | 10 | 0 |
| 春菊×20 | 30 | 20 | 0 | 20 |
| 青梗菜×15 | 20 | 15 | 0 | 15 |
| ネギバラ×500 | 50 | 500 | 10 | 0 |
| 胡瓜バラ100×10（箱数で受信） | 100 | 1000 | 10 | 0 |
| 胡瓜平箱×1（箱数で受信） | 50 | 50 | 1 | 0 |

上記は `tests/test_calculation_logic_canonical.py` で検証する。

---

## 変更時のチェックリスト

- [ ] **【致命】** プロンプト・解析で「×の後＝合計数量」を守っているか（「×の後＝箱数」や「×の後×入数＝total」にしていないか）
- [ ] **【致命】** `_fix_total_when_ai_sent_boxes_times_unit` は **total > 1000** のときだけ補正する条件を維持しているか（total=300/500 を補正しない）
- [ ] 計算は `box_remainder_calc` の関数を使ったか（`//` / `%` の直書きをしていないか）
- [ ] unit=0, total=0, total&lt;unit のケースを考慮したか
- [ ] 不変条件 `total = unit*boxes+remainder`、`0 <= remainder < unit` を満たすか
- [ ] 必要なら `tests/test_box_remainder_calc.py`、`tests/test_calculation_logic_canonical.py`、`tests/test_order_processing.py` にテストを追加し、`scripts/run_calculation_tests.*` で全件通過したか
- [ ] 特別な解釈（「unitが総数」など）には理由のコメントを付けたか
