# kojima-farm-app-v3 網羅的改善レビュー

多方面から見た評価と改善の方向性を整理しました。運用や今後の拡張の参考にしてください。

---

## 1. 機能・UX

| 観点 | 現状 | 改善の方向性 |
|------|------|----------------|
| **画面構成** | 現場用／事務用でメニュー分離、タブで画像解析・メール・未確定・PDF・設定を整理 | そのまま維持。必要なら「よく使う操作」をトップに寄せるショートカットを検討 |
| **入力の手間** | 台帳スプレッドシートIDはタブごとに入力（Secrets に `DELIVERY_SPREADSHEET_ID` を入れておくと初期値が入る） | Secrets の `DELIVERY_SPREADSHEET_ID` を全タブで参照するように統一済み。未設定時はデフォルトIDを表示 |
| **エラー表示** | 日本語の理由＋詳細（修正用）で表示（`error_display_util`） | 運用で気になる文言があれば `_reason_ja` の分岐を追加 |
| **一括操作** | 事務用で「すべて選択」→ 一括適用、シートは1回読み＋1回書きで高速化済み | 問題なければ現状維持。将来的に「選択解除」ボタンがあると便利な場合あり |
| **品目・規格** | 解析結果で品目・規格を選択＋手入力のハイブリッド、品目名管理をGeminiプロンプトに反映 | 新規品目は品目名管理で追加する運用で一貫 |

---

## 2. 運用・保守

| 観点 | 現状 | 改善の方向性 |
|------|------|----------------|
| **設定の持ち運び** | `config/` に stores, items, item_spec_master, item_settings, units を JSON で保存 | 本番・検証で同じ設定を使う場合は `config/` をコピーまたはバックアップして運用。Secrets は環境ごと |
| **台帳の列** | 納品単価・納品金額は手動または列追加機能で対応。確定は「確定フラグ」のみ使用 | 詳細列は手動で追加・編集してよい。ステータス列は廃止済み |
| **ログ・監査** | Streamlit の標準ログ。台帳の確定日時で「いつ確定したか」は残る | 本格的な監査が必要なら、操作ログをファイルまたはスプレッドシートに追記する機能を検討 |
| **バージョン** | requirements.txt で主要ライブラリを固定 | 定期的に `pip list --outdated` で確認し、破壊的変更のない範囲でアップデート |

---

## 3. セキュリティ

| 観点 | 現状 | 改善の方向性 |
|------|------|----------------|
| **APIキー・認証** | Gemini APIキーは Secrets／サイドバー入力。GCP は Secrets の `[gcp]` または環境変数 | キーをリポジトリに含めないこと（.gitignore で secrets.toml 除外済み）を徹底 |
| **メールパスワード** | 保存しない運用を推奨（DEPLOY.md）。入力はマスク表示 | 運用で「保存」にチェックを入れないよう、注意書きで案内済みなら十分 |
| **XSRF・CORS** | .streamlit/config.toml で enableXsrfProtection=true, enableCORS=false | そのまま推奨。公開URLを知られないようにする運用も有効 |
| **スプレッドシート** | サービスアカウントを「編集者」で共有。必要最小限のシートだけ共有するとよい | 本番用と検証用で別スプレッドシート／別サービスアカウントの検討 |

---

## 4. パフォーマンス

| 観点 | 現状 | 改善の方向性 |
|------|------|----------------|
| **台帳の読み書き** | 一括適用は「1回読み＋1回 update_cells」。取得は日付範囲で絞り込み | 行数が極端に多い場合は「日付範囲を狭める」「ページング」の検討 |
| **画像解析** | 1枚ずつ Gemini に送信。大きな画像はメモリを消費 | 解像度を落とす／枚数制限の案内を「画像解析」タブに書いてもよい |
| **メール取得** | IMAP で「何日分」を指定して取得 | days_back を大きくしすぎないよう注意書きで案内 |

---

## 5. 品質・テスト

| 観点 | 現状 | 改善の方向性 |
|------|------|----------------|
| **単体テスト** | tests/ に config_manager, delivery_converter, order_processing のテストあり | 新機能追加時に該当モジュールのテストを足す。CI で pytest を回すと安心 |
| **手動確認** | 画像解析・メール・台帳・PDF は実際の環境で確認が必要 | チェックリスト（「画像アップロード→解析→ラベル→PDF」「事務用で一括適用」など）を README や docs に残すと引き継ぎしやすい |
| **エラーハンドリング** | 主要な例外で format_error_display を使用。バックエンドは (ok, msg) で返却 | 新APIを呼ぶ箇所では同様に try/except とメッセージ返却を統一 |

---

## 6. ドキュメント

| 観点 | 現状 | 改善の方向性 |
|------|------|----------------|
| **README** | セットアップ・実行・Streamlit Cloud の概要 | プロジェクト構成・config の役割・トラブル時の確認項目を追記するとよい |
| **DEPLOY.md** | デプロイ手順・Secrets の例 | そのまま維持。環境変数名を変えた場合はここを更新 |
| **docs/** | UI/UX 評価・未確定一覧のアイデア・デバッグレポート等 | 今回の「網羅的改善レビュー」を追加。大きな仕様変更のたびに日付と内容をメモすると履歴になる |

---

## 7. 今後の拡張（任意）

- **台帳の「詳細」列**: 手動で追加・編集する運用で対応可能。アプリから詳細を編集して保存したい場合は、一括更新の対象列に「詳細」を追加する実装で対応可能。
- **複数台帳**: 現在は1つの台帳ID（Secrets または入力）を前提。複数プロジェクトで別台帳を使う場合は、台帳を選択するドロップダウンや環境切り替えの検討。
- **権限・ロール**: 現場用のみ／事務用のみなど、メニューを権限で出し分ける場合は、簡易的に「パスワードで事務用を表示」などの拡張が考えられる。
- **バックアップ**: config/ の JSON を定期的にエクスポートするボタンや、台帳のスナップショット取得は、運用で必要になったら検討。

---

## まとめ

- **機能・UX**: 現場用／事務用の分離、一括選択・一括適用、品目名管理のプロンプト反映など、必要な機能は揃っている。Secrets で台帳IDを一元化すると入力の手間が減る。
- **運用・保守**: config/ のバックアップと、台帳の「確定フラグ」「納品単価・納品金額」の役割を把握しておくと運用しやすい。
- **セキュリティ**: Secrets と .gitignore の運用を守り、必要に応じて本番／検証の分離を検討。
- **パフォーマンス**: 台帳の一括更新はすでに最適化済み。画像・メールは利用方法の案内で十分。
- **品質**: 既存テストを活かしつつ、新機能ではテストと手動チェックリストで品質を維持。
- **ドキュメント**: README と DEPLOY.md を少しずつ充実させ、大きな変更は docs にメモするとよい。

上記を踏まえ、優先度の高いものから少しずつ取り入れると、さらに使いやすく保守しやすい状態を保てます。
