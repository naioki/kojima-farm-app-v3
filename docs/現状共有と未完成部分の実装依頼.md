# 現状の共有と、未完成部分の実装依頼

## 1. 開発の現状

このプロジェクトは開発途中です。既存の成果物と、解決できていない課題を共有し、引き継ぎ・継続開発に使います。

---

## 2. 共有する資料

### 2.1 既存コード

- **リポジトリ**: https://github.com/naioki/kojima-farm-app-v3
- **ローカル（Git 用）**: `C:\Users\naiok\.cursor\projects\kojima-farm-app-v3`
- **主なファイル**:
  - `app.py` … Streamlit メイン（画像解析・メール取得・納品データ形式・台帳追記・未確定一覧・設定・PDF生成）
  - `delivery_converter.py` … v2形式⇔納品行⇔台帳行の変換
  - `delivery_sheet_writer.py` … スプレッドシートへの追記・台帳からの取得
  - `pdf_generator.py` … 出荷ラベルPDF（A4・8分割・Cut and Stack・一覧表）
  - `email_reader.py` … IMAPでメール取得・画像抽出
  - `config_manager.py` / `email_config_manager.py` … 店舗・品目・入数・メール設定
  - `config/stores.json`, `config/items.json` … マスタデータ

### 2.2 スプレッドシート構成（台帳）

- **スプレッドシートID**: `1KJtpiaPjyH2bTaxULWwgemhZTCymfvsZPftfryQzXG4`
- **シート名**: 例として「シート1」または「台帳データ」
- **1行目（ヘッダー）**:

| A | B | C | D | E | F | G | H | I | J |
|---|--|--|--|--|--|--|--|--|--|
| 納品日付 | 納品先 | 規格 | 品目 | 数量 | 農家 | 確定フラグ | 確定日時 | チェック | 納品ID |

- **確定フラグ**: 未確定 / 確定 など。空または「未確定」＝未確定行。
- **確定日時**: AppSheet 等で確定した日時（文字列で可）。
- データは2行目以降に追記。現状は「追記のみ」で、既存行の上書きは未実装。

### 2.3 作成済みの機能

| 機能 | 状態 |
|------|------|
| 画像アップロード → Gemini 解析 → 編集 → 台帳に「未確定」で追記 | ✅ 実装済み |
| メールから画像取得 → 解析 → 編集 → 台帳に「未確定」で追記 | ✅ 実装済み |
| 台帳から「未確定」行のみ取得して一覧表示（未確定一覧タブ） | ✅ 実装済み |
| 解析結果 → 納品データ形式プレビュー・CSV ダウンロード | ✅ 実装済み |
| 出荷ラベル PDF 生成（画像解析タブのデータから） | ✅ 実装済み |
| Streamlit Cloud デプロイ・GCP Secrets での台帳連携 | ✅ 手順・設定済み |
| **数量変更時の既存行の上書き／追記ロジック** | ❌ 未実装 |
| **AppSheet 修正後 → その場で PDF 生成・表示** | ❌ 未実装（Streamlit 側の「台帳確定データ→PDF」は未実装） |
| **取引先別メール形式の汎用解析** | ❌ 未実装（現状は1プロンプト＋画像のみ） |

---

## 3. 現在のボトルネック（ここを直してほしい）

### 課題1: 数量が後から変わった際の、スプレッドシート既存行の「上書き」または「追記」ロジックが未完成

- **現状**: 台帳への書き込みは `append_ledger_rows` による**追記のみ**。同じ注文で数量だけ変更した場合の「既存行を更新する」または「修正行をどう追記するか」のルールがない。
- **必要な方針の例**:
  - **上書き**: 納品ID（または 納品日付+納品先+品目+規格 の組み合わせ）で行を特定し、その行の「数量」等を更新する。
  - **追記のみ＋確定で統合**: 修正は常に新行で追記し、確定時に「同じ納品単位」の行をマージしてPDF・請求に使う（やや複雑）。
- **推奨**: まずは「納品ID」で行を一意にし、**数量変更時はその行を上書きする** API を用意するのが扱いやすい。

### 課題2: AppSheet で修正した後に、その場で PDF（差し札）を生成して画面に表示させる連携がスムーズにできていない

- **現状**: PDF は「画像解析タブで編集した session_state のデータ」からしか生成していない。台帳の「確定済み」データを取得して PDF に渡すフローがない。
- **必要なこと**:
  - 台帳から「確定フラグ＝確定」かつ「指定した納品日（または確定日）」の行を取得する。
  - その行を `generate_labels_from_data` が受け取れる形式（store, item, spec, unit, boxes, remainder）に変換する。台帳には「数量」しかないため、**unit は品目マスタから取得し、quantity → boxes / remainder に分解**するロジックが必要。
  - Streamlit に「日付を指定 → 台帳から確定データ取得 → PDF 生成 → ダウンロード」の画面を追加する。
- **AppSheet 側**: AppSheet から「PDF 生成」を押したときに Streamlit の URL（クエリで日付渡し）を開く、または Webhook で Streamlit に通知するなどの連携は別途検討。まずは **Streamlit 上で「台帳の確定データから PDF」** を実装すると、手動で日付指定して再発行できる。

### 課題3: 取引先ごとに微妙に異なるメール形式を、一つの解析ロジックで汎用的に処理したい

- **現状**: メールは `email_reader` で画像を取得し、`parse_order_image` で **1つの Gemini プロンプト** で画像を解析している。メール本文のテキストや、取引先別のフォーマット（表形式・文言の違い）には対応していない。
- **必要なこと**:
  - **入力の汎用化**: 画像だけでなく「メール本文テキスト」も入力に含め、取引先ごとのテンプレート（キーワード・表の列名・単位の表記）を設定で持つ。
  - **解析の分岐**: 送信者（またはメール種別）で「画像のみ解析」「本文のみ解析」「画像＋本文の併用」を切り替え、いずれも共通の「v2形式（store, item, spec, unit, boxes, remainder）」に正規化する。
  - **設定例**: 取引先メールアドレス or ドメイン → 使用するプロンプト名 or パースルール（「表の2列目が品目」など）を config または DB で管理。

---

## 4. 次の具体的なステップ

### 4.1 今のコードのままで良い点

- **delivery_converter.py**: 日付正規化・安全な数値変換・v2⇔台帳行の変換はそのまま利用可能。`delivery_rows_to_v2_format` は「数量」のみの行を v2 形式にしているが、PDF 用には unit/boxes/remainder の分解が必要なため、**台帳用の `ledger_rows_to_v2_format`（数量→unit/boxes/remainder 分解あり）を追加**する形がよい。
- **delivery_sheet_writer.py**: 認証・追記・未確定一覧取得はそのままでよい。**既存行の上書き**用に `update_ledger_row_by_id`（納品ID 指定で1行更新）を追加する。
- **pdf_generator.py**: 変更不要。ラベルレイアウト・一覧表・Cut and Stack は現状のまま利用。
- **app.py の parse_order_image / validate_and_fix_order_data / generate_labels_from_data**: 画像解析とラベル生成の核はそのまま。**台帳確定データ用の「日付指定→取得→v2形式に変換→PDF」** を新タブまたは新ブロックで追加する。
- **email_reader.py**: 画像抽出はそのまま。取引先別対応は **「解析前に送信者で分岐し、本文を渡すかどうか」** を追加する形がよい。
- **config_manager / stores・items.json**: 店舗・品目・入数マスタはそのまま。取引先別メール設定用に `config/mail_senders.json` などを追加可能。

### 4.2 全体最適のために書き換える／追加すべき点

| 箇所 | 内容 |
|------|------|
| delivery_sheet_writer | **update_ledger_row_by_id(spreadsheet_id, sheet_name, 納品ID, 更新する列の辞書)** を追加。gspread で行を検索し、該当行のセルを更新。 |
| delivery_converter | **ledger_rows_to_v2_format(ledger_rows, 品目マスタで unit 解決)** を追加。数量のみの行から unit/boxes/remainder を逆算し、`generate_labels_from_data` に渡せる形式にする。 |
| app.py | **「台帳からPDF」** ブロック: 納品日（または確定日）入力 → 台帳から確定済み行取得 → ledger_rows_to_v2_format → PDF 生成 → ダウンロード。 |
| app.py | **数量変更時の上書き**: 未確定一覧で行を選択し「数量を更新して台帳に反映」ボタンで `update_ledger_row_by_id` を呼ぶ、などの UI を検討。 |
| メール解析 | **取引先別**: 送信者で分岐し、本文テキストを取得して渡す処理と、プロンプトまたはルールを差し替える設定を追加。 |

### 4.3 まず着手すべき修正案（優先順）

1. **課題1（数量変更・上書き）**
   - `delivery_sheet_writer.py` に **`update_ledger_row_by_id`** を実装する。
   - 引数: spreadsheet_id, sheet_name, 納品ID, 更新キー（例: 数量, 確定フラグ, 確定日時）。
   - 実装方針: `get_all_values` でヘッダーとデータを取得 → 納品ID 列で行番号を特定 → `sheet.update_cell(row_idx, col_idx, value)` で該当セルのみ更新。
   - app.py の「未確定一覧」で、取得した表の行を編集可能にして「台帳に反映」で上書きする、または「数量を編集してこの行を更新」ボタンを追加する。

2. **課題2（台帳確定データ→PDF）**
   - `delivery_converter.py` に **`ledger_rows_to_v2_format_with_units(ledger_rows, get_item_setting_func)`** を追加。各台帳行の「品目・規格」で unit をマスタから取得し、数量を boxes/remainder に分解。
   - `delivery_sheet_writer.py` に **`fetch_ledger_rows(..., only_unconfirmed=False)`** は既にあるので、納品日付でフィルタするオプション（例: `delivery_date_from`, `delivery_date_to`）を追加するか、取得後に Python でフィルタする。
   - app.py に **「📄 台帳からPDF」** セクション: 納品日入力・「確定済みデータを取得」→ 表表示 → 「PDFを生成」で `ledger_rows_to_v2_format_with_units` → `generate_labels_from_data` → PDF ダウンロード。

3. **課題3（取引先別メール形式）**
   - 設定として「送信者メール or ドメイン → 使用する解析モード（画像のみ / 本文のみ / 画像＋本文）」と「本文用プロンプトまたはルール名」を保持する。
   - `email_reader` で本文プレーンテキストを取得する関数を追加し、app.py のメール取得ループで「画像」に加えて「本文」を解析に渡す分岐を入れる。
   - 解析側: 画像の場合は現行の `parse_order_image`。本文の場合は `parse_order_text(body, sender)` を新設し、sender に応じたプロンプトで Gemini にテキストだけ送り、同じ v2 JSON 形式で返す。

---

## 5. まとめ

- **現状**: メール/画像→解析→台帳に未確定で追記・未確定一覧表示・画像ベースのPDF生成まで実装済み。台帳は「追記のみ」で、確定データからPDFを出すフローと、取引先別メール解析は未実装。
- **優先実装**: (1) 台帳の既存行を納品IDで更新する API と UI、(2) 台帳の確定データを日付指定で取得し PDF に渡す変換と画面、(3) 取引先別のメール解析（本文対応・設定で分岐）。

上記の「まず着手すべき修正案」に沿って、必要な関数・画面から順に実装を進めると、ボトルネックが解消されます。
