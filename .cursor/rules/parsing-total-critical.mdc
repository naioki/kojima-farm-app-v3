---
description: 注文解析の「×の後＝合計数量」ルールは致命的。プロンプト・解析ロジック変更時は必ず守る
globs: ["**/order_processing.py", "**/docs/プロンプト内容整理.md", "**/docs/計算ロジックと品質保証.md"]
alwaysApply: true
---

# 致命的ルール：注文の「×」解釈と計算

**このルールを破ると注文数量が桁違いになり、出荷・請求に致命的な誤りが発生します。**

## 絶対に守ること

### 1. 「×」の直後の数字 ＝ 合計数量（総数）

- 注文メール・画像の「品目×数字」の**数字は合計数量**。箱数ではない。
- **正しい例**: 胡瓜3本×150 → total=**150**（箱数5, 端数0）。春菊×20 → total=**20**（箱数0, 端数20）。
- **禁止**: 「×150」を150箱と解釈して total=4500 にすること。「春菊×20」を total=600(20×30) にすること。

### 2. 例外は2つだけ

- **箱数で受信する品目**（胡瓜平箱など）のみ：「×」の後を箱数とし、total=箱数×入数。
- **「50×4」の掛け算表記**：50×4=200 を total に。

### 3. 箱数・端数は必ず total から算出

- 箱数 = 合計数量 ÷ 入数 の商、端数 = 余り。`box_remainder_calc.total_to_boxes_remainder(total, unit)` を使う。

## プロンプトを編集するとき

- 「春菊×20→total=600」「青梗菜×15→total=300」など**誤った例をプロンプトに書かない。**
- 正しい例のみ: 春菊×20→**total=20**、胡瓜3本×150→**total=150**。
- 変更後は `docs/計算ロジックと品質保証.md` の「致命的に守るべきルール」と矛盾していないか確認する。

## 補正の条件（変更禁止）

- `_fix_total_when_ai_sent_boxes_times_unit` は **total > 1000** のときだけ実行。total=300（箱数10×入数30）や total=500 は正しいので補正しない。

## 参照

- 詳細は `docs/計算ロジックと品質保証.md` の「致命的に守るべきルール」「現在の正解ロジック」を毎回確認すること。
- 変更後は `tests/test_calculation_logic_canonical.py` が通ることを確認すること。
